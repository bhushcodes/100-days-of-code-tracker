<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Log Your Progress - 100 Days Tracker</title>
  <link rel="stylesheet" href="styles-custom.css">
  <style>
    body {
      padding: 2rem;
      min-height: 100vh;
      background: linear-gradient(135deg, var(--neo-purple) 0%, var(--neo-pink) 100%);
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      border: 5px solid var(--neo-border);
      box-shadow: 8px 8px 0 var(--neo-border);
      padding: 3rem;
    }
    
    .header {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .header h1 {
      font-size: 2.5rem;
      color: var(--neo-purple);
    }
    
    .user-info {
      background: var(--neo-green);
      border: 4px solid var(--neo-border);
      padding: 1rem;
      margin-bottom: 2rem;
      text-align: center;
      font-weight: 700;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-group label {
      display: block;
      font-weight: 700;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
    }
    
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 0.8rem;
      border: 4px solid var(--neo-border);
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1rem;
      background: #f5f5f5;
    }
    
    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .btn {
      width: 100%;
      padding: 1rem 2rem;
      border: 4px solid var(--neo-border);
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      text-transform: uppercase;
      box-shadow: 6px 6px 0 var(--neo-border);
      font-family: 'Space Grotesk', sans-serif;
      background: var(--neo-green);
      color: #000;
      margin-top: 1rem;
    }
    
    .btn:hover {
      transform: translate(3px, 3px);
      box-shadow: 3px 3px 0 var(--neo-border);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .status-box {
      padding: 1rem;
      border: 4px solid var(--neo-border);
      margin-bottom: 1rem;
      display: none;
    }
    
    .status-box.active {
      display: block;
    }
    
    .status-box.success {
      background: var(--neo-green);
    }
    
    .status-box.error {
      background: #ff6b6b;
      color: #fff;
    }
    
    .status-box.info {
      background: var(--neo-cyan);
    }
    
    .success-message {
      background: var(--neo-green);
      border: 4px solid var(--neo-border);
      padding: 2rem;
      text-align: center;
      margin-top: 2rem;
      display: none;
    }
    
    .success-message.active {
      display: block;
    }
    
    .tech-suggestions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }
    
    .tech-btn {
      padding: 0.5rem 1rem;
      background: var(--neo-cyan);
      border: 3px solid var(--neo-border);
      font-weight: 700;
      cursor: pointer;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìù Log Your Progress</h1>
      <p>You're logged in! Let's track today's coding.</p>
    </div>

    <div class="user-info" id="userInfo">
      ‚úÖ Logged in as: <span id="usernameDisplay"></span>
    </div>

    <div class="status-box" id="statusBox"></div>

    <form id="logForm">
      <div class="form-group">
        <label for="summary">What did you code today? (Min 20 chars)</label>
        <textarea id="summary" placeholder="Be specific..." required minlength="20"></textarea>
        <small style="color: #666;">Characters: <span id="charCount">0</span>/20</small>
      </div>

      <div class="form-group">
        <label for="technologies">Technologies Used</label>
        <input type="text" id="technologies" placeholder="React, JavaScript, CSS" required>
        <div class="tech-suggestions">
          <small style="width:100%;font-weight:700;">üí° Quick add:</small>
          <button type="button" class="tech-btn" onclick="addTech('JavaScript')">JavaScript</button>
          <button type="button" class="tech-btn" onclick="addTech('Python')">Python</button>
          <button type="button" class="tech-btn" onclick="addTech('React')">React</button>
          <button type="button" class="tech-btn" onclick="addTech('HTML')">HTML</button>
          <button type="button" class="tech-btn" onclick="addTech('CSS')">CSS</button>
          <button type="button" class="tech-btn" onclick="addTech('Node.js')">Node.js</button>
        </div>
      </div>

      <div class="form-group">
        <label for="links">Project Link (optional)</label>
        <input type="url" id="links" placeholder="https://github.com/username/project">
      </div>

      <div class="form-group">
        <label for="highlight">Today's Highlight! üéâ</label>
        <input type="text" id="highlight" placeholder="What made you proud?" required>
      </div>

      <button type="submit" class="btn" id="submitBtn">
        üöÄ Log & Commit to GitHub
      </button>
    </form>

    <div class="success-message" id="successMessage">
      <h2>üéâ Success!</h2>
      <p id="successText"></p>
      <p><a href="index.html" style="color:var(--neo-purple);font-weight:700;">‚Üê Back to Dashboard</a></p>
    </div>
  </div>

  <script>
    // Get token and username from URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const username = urlParams.get('username');
    const repo = '100-days-of-code-tracker';

    if (!token || !username) {
      alert('‚ùå Authentication failed! Please try again.');
      window.location.href = 'log-oauth-login.html';
    }

    // Display username
    document.getElementById('usernameDisplay').textContent = username;

    // Save for session
    sessionStorage.setItem('github_token', token);
    sessionStorage.setItem('username', username);

    // Character counter
    document.getElementById('summary').addEventListener('input', (e) => {
      document.getElementById('charCount').textContent = e.target.value.length;
    });

    function addTech(tech) {
      const input = document.getElementById('technologies');
      const current = input.value.trim();
      if (current) {
        const techs = current.split(',').map(t => t.trim());
        if (!techs.includes(tech)) {
          input.value = current + ', ' + tech;
        }
      } else {
        input.value = tech;
      }
    }

    function showStatus(message, type = 'info') {
      const statusBox = document.getElementById('statusBox');
      statusBox.textContent = message;
      statusBox.className = `status-box active ${type}`;
      statusBox.scrollIntoView({ behavior: 'smooth' });
    }

    function hideStatus() {
      document.getElementById('statusBox').classList.remove('active');
    }

    function encodeToBase64(str) {
      const utf8Bytes = new TextEncoder().encode(str);
      const chunkSize = 0x8000;
      let binary = '';
      for (let i = 0; i < utf8Bytes.length; i += chunkSize) {
        const chunk = utf8Bytes.subarray(i, i + chunkSize);
        binary += String.fromCharCode(...chunk);
      }
      return btoa(binary);
    }

    function decodeFromBase64(base64) {
      const sanitized = base64.replace(/\s/g, '');
      const binary = atob(sanitized);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
      }
      return new TextDecoder().decode(bytes);
    }

    function getLocalDateString() {
      const now = new Date();
      const offsetMs = now.getTimezoneOffset() * 60000;
      const local = new Date(now.getTime() - offsetMs);
      return local.toISOString().split('T')[0];
    }

    async function listDirectory(path) {
      const response = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${path}`, {
        headers: {
          'Authorization': `token ${token}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      });

      if (response.status === 404) {
        return [];
      }

      if (!response.ok) {
        throw new Error(`GitHub API error: ${response.status}`);
      }

      const data = await response.json();
      if (!Array.isArray(data)) {
        throw new Error(`Expected directory listing for ${path}`);
      }
      return data;
    }

    function toUtcDate(dateString) {
      return new Date(`${dateString}T00:00:00Z`);
    }

    function daysBetweenUtc(laterDate, earlierDate) {
      const msPerDay = 24 * 60 * 60 * 1000;
      return Math.floor((laterDate - earlierDate) / msPerDay);
    }

    function shortenText(text, maxLength = 80) {
      if (!text) return '';
      if (text.length <= maxLength) return text;
      const trimmed = text.slice(0, maxLength).trimEnd();
      const lastSpace = trimmed.lastIndexOf(' ');
      if (lastSpace > 0 && lastSpace > maxLength * 0.6) {
        return trimmed.slice(0, lastSpace).trimEnd() + '‚Ä¶';
      }
      return trimmed + '‚Ä¶';
    }

    function calculateStreaks(dateStrings) {
      if (!dateStrings.length) {
        return { current: 0, longest: 0 };
      }

      const msPerDay = 24 * 60 * 60 * 1000;
      const timestamps = dateStrings
        .map(str => toUtcDate(str).getTime())
        .sort((a, b) => a - b);

      let longest = 1;
      let currentRun = 1;

      for (let i = 1; i < timestamps.length; i++) {
        const diff = Math.round((timestamps[i] - timestamps[i - 1]) / msPerDay);
        if (diff === 0) {
          continue;
        }
        if (diff === 1) {
          currentRun += 1;
        } else {
          longest = Math.max(longest, currentRun);
          currentRun = 1;
        }
      }
      longest = Math.max(longest, currentRun);

      let current = 1;
      for (let i = timestamps.length - 1; i > 0; i--) {
        const diff = Math.round((timestamps[i] - timestamps[i - 1]) / msPerDay);
        if (diff === 0) {
          continue;
        }
        if (diff === 1) {
          current += 1;
        } else {
          break;
        }
      }

      if (!timestamps.length) {
        current = 0;
        longest = 0;
      }

      return { current, longest };
    }

    function buildLeaderboardStats(logs) {
      const now = new Date();
      const todayUtc = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));

      const stats = [];

      for (const log of logs) {
        if (!log || !log.user || !Array.isArray(log.entries) || !log.entries.length) {
          continue;
        }

        const entries = [...log.entries].sort((a, b) => {
          const dateA = a.date || '';
          const dateB = b.date || '';
          return dateA.localeCompare(dateB);
        });

        const dateStrings = entries.map(entry => entry.date).filter(Boolean);
        if (!dateStrings.length) {
          continue;
        }

        const firstDay = dateStrings[0];
        const lastDay = dateStrings[dateStrings.length - 1];
        const lastDate = toUtcDate(lastDay);
        const daysSinceUpdate = Math.max(0, daysBetweenUtc(todayUtc, lastDate));
        const { current, longest } = calculateStreaks(dateStrings);
        const latestSummary = entries[entries.length - 1].summary || '';

        stats.push({
          user: log.user,
          total_days: entries.length,
          current_streak: current,
          longest_streak: longest,
          active_streak: daysSinceUpdate <= 1,
          last_update: lastDay,
          first_day: firstDay,
          highlight: shortenText(latestSummary, 80),
          days_since_update: daysSinceUpdate
        });
      }

      stats.sort((a, b) => {
        if (b.current_streak !== a.current_streak) return b.current_streak - a.current_streak;
        if (b.longest_streak !== a.longest_streak) return b.longest_streak - a.longest_streak;

        const aDays = typeof a.days_since_update === 'number' ? a.days_since_update : Number.POSITIVE_INFINITY;
        const bDays = typeof b.days_since_update === 'number' ? b.days_since_update : Number.POSITIVE_INFINITY;
        if (aDays !== bDays) return aDays - bDays;

        return a.user.localeCompare(b.user, undefined, { sensitivity: 'base' });
      });

      return stats;
    }

    function buildLeaderboardMarkdown(stats, generatedAt) {
      const displayTimestamp = generatedAt.replace('T', ' ').replace('+00:00', ' UTC');
      const lines = [
        '# üèÜ Community Leaderboard',
        '',
        '> **Note:** This file is auto-generated by `scripts/update_leaderboard.py`  ',
        '> View the live, interactive version at: **[100-days-of-code-tracker.netlify.app](https://100-days-of-code-tracker.netlify.app/)**',
        '',
        `Last updated: ${displayTimestamp}`,
        '',
        '---',
        '',
        '| Rank | User | Days Logged | Current Streak | Longest Streak | Last Activity | Status | Highlight |',
        '| ---- | ---- | ----------- | -------------- | -------------- | ------------- | ------ | --------- |'
      ];

      stats.forEach((item, index) => {
        const status = item.active_streak ? 'active' : 'paused';
        lines.push(`| ${index + 1} | ${item.user} | ${item.total_days} | ${item.current_streak} | ${item.longest_streak} | ${item.last_update || 'n/a'} | ${status} | ${item.highlight || ''} |`);
      });

      return lines.join('\n');
    }

    async function rebuildLeaderboard(dayNumber) {
      const files = await listDirectory('logs/users');
      if (!files.length) {
        throw new Error('No log files found while rebuilding leaderboard.');
      }

      const logs = [];
      for (const file of files) {
        if (file.type !== 'file' || !file.name.endsWith('.json')) {
          continue;
        }
        try {
          const fileData = await getFileContent(file.path);
          if (fileData && fileData.content) {
            logs.push(fileData.content);
          }
        } catch (error) {
          console.error(`Failed to load log file ${file.path}`, error);
        }
      }

      if (!logs.length) {
        throw new Error('Unable to read any user logs for leaderboard update.');
      }

      const stats = buildLeaderboardStats(logs);
      if (!stats.length) {
        throw new Error('No valid participant data available for leaderboard.');
      }

      const generatedIso = new Date().toISOString();
      const generatedAt = generatedIso.replace('Z', '+00:00');
      const message = `Day ${dayNumber}: ${username} updated leaderboard`;

      const leaderboardData = {
        generated_at: generatedAt,
        users: stats
      };

      const dataFile = await getFileContent('data/leaderboard.json').catch(() => null);
      const websiteFile = await getFileContent('website/data/leaderboard.json').catch(() => null);
      const docsFile = await getFileContent('docs/LEADERBOARD.md', false).catch(() => null);

      await updateFile(
        'data/leaderboard.json',
        leaderboardData,
        message,
        dataFile ? dataFile.sha : null
      );

      await updateFile(
        'website/data/leaderboard.json',
        leaderboardData,
        message,
        websiteFile ? websiteFile.sha : null
      );

      const markdown = buildLeaderboardMarkdown(stats, generatedAt);
      await updateFile(
        'docs/LEADERBOARD.md',
        markdown,
        message,
        docsFile ? docsFile.sha : null
      );
    }

    async function getFileContent(path, parseJson = true) {
      const response = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${path}`, {
        headers: {
          'Authorization': `token ${token}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      });
      
      if (response.status === 404) {
        return null;
      }
      
      if (!response.ok) {
        throw new Error(`GitHub API error: ${response.status}`);
      }
      
      const data = await response.json();
      const content = decodeFromBase64(data.content);
      return { content: parseJson ? JSON.parse(content) : content, sha: data.sha };
    }

    async function updateFile(path, content, message, sha = null) {
      const serialized = typeof content === 'string' ? content : JSON.stringify(content, null, 2);
      const body = {
        message: message,
        content: encodeToBase64(serialized)
      };
      
      if (sha) {
        body.sha = sha;
      }
      
      const response = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${path}`, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Failed to update file');
      }
      
      return await response.json();
    }

    document.getElementById('logForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const summary = document.getElementById('summary').value.trim();
      const technologies = document.getElementById('technologies').value
        .split(',')
        .map(t => t.trim())
        .filter(t => t);
      const links = document.getElementById('links').value.trim();
      const highlight = document.getElementById('highlight').value.trim();

      if (summary.length < 20) {
        showStatus('‚ùå Summary must be at least 20 characters!', 'error');
        return;
      }

      if (technologies.length === 0) {
        showStatus('‚ùå Please add at least one technology!', 'error');
        return;
      }

      document.getElementById('submitBtn').disabled = true;
      showStatus('‚è≥ Connecting to GitHub...', 'info');

      try {
        const logPath = `logs/users/${username}.json`;
        showStatus('‚è≥ Reading your log file...', 'info');
        
        let logData = null;
        let fileSha = null;
        
        try {
          const fileData = await getFileContent(logPath);
          if (fileData) {
            logData = fileData.content;
            fileSha = fileData.sha;
          }
        } catch (error) {
          console.log('File does not exist, will create new one');
        }

        if (!logData) {
          logData = {
            user: username,
            entries: []
          };
        }

        const today = getLocalDateString();
        const alreadyLogged = logData.entries.some(entry => entry.date === today);
        
        if (alreadyLogged) {
          showStatus('‚ùå You already logged today! Come back tomorrow.', 'error');
          document.getElementById('submitBtn').disabled = false;
          return;
        }

        const dayNumber = logData.entries.length + 1;
        const newEntry = {
          day: dayNumber,
          date: today,
          summary: summary,
          technologies: technologies,
          links: links ? [links] : [],
          highlight: highlight,
          timestamp: new Date().toISOString()
        };

        logData.entries.push(newEntry);

        showStatus('‚è≥ Committing to GitHub...', 'info');
        await updateFile(
          logPath,
          logData,
          `Day ${dayNumber}: ${username} logged progress`,
          fileSha
        );

        let leaderboardUpdated = true;
        try {
          showStatus('‚è≥ Updating leaderboard...', 'info');
          await rebuildLeaderboard(dayNumber);
        } catch (lbError) {
          leaderboardUpdated = false;
          console.error('Leaderboard update failed:', lbError);
          showStatus('‚ö†Ô∏è Entry saved, but the leaderboard could not be refreshed automatically. Please run python3 scripts/update_leaderboard.py manually.', 'error');
        }

        if (leaderboardUpdated) {
          hideStatus();
        }
        document.getElementById('logForm').style.display = 'none';
        document.getElementById('successMessage').classList.add('active');
        document.getElementById('successText').innerHTML = `
          <strong>Day ${dayNumber} logged successfully!</strong><br>
          üî• Current streak: ${dayNumber} days<br>
          üí™ ${100 - dayNumber} days to go!<br><br>
          ${leaderboardUpdated ? '' : '‚ö†Ô∏è Leaderboard update failed. Please refresh manually.<br><br>'}
          <a href="https://github.com/${username}/${repo}" target="_blank" style="color:var(--neo-purple);">
            View on GitHub ‚Üí
          </a>
        `;

      } catch (error) {
        console.error('Error:', error);
        showStatus(`‚ùå Error: ${error.message}`, 'error');
        document.getElementById('submitBtn').disabled = false;
      }
    });
  </script>
</body>
</html>
